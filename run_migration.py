# run_migration.py - Script Principal Migration ERP Production DG Inc.
# Ex√©cution compl√®te de la migration JSON ‚Üí SQLite

import os
import sys
import json
import logging
import argparse
from datetime import datetime
from pathlib import Path

# Import des modules de migration
from erp_database import ERPDatabase
from migration_scripts import MigrationManager, validate_migration_results
from test_migration import run_performance_test

# Configuration logging
logging.basicConfig(
    level=logging.INFO,
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s',
    handlers=[
        logging.FileHandler('migration.log'),
        logging.StreamHandler(sys.stdout)
    ]
)
logger = logging.getLogger(__name__)

def print_banner():
    """Affiche la banni√®re ERP Production DG Inc."""
    banner = """
    ‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
    ‚ïë               üè≠ ERP Production DG Inc.                      ‚ïë
    ‚ïë                 Migration JSON ‚Üí SQLite                      ‚ïë
    ‚ïë                                                              ‚ïë
    ‚ïë         Transformation vers Architecture Unifi√©e            ‚ïë
    ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù
    """
    print(banner)

def check_prerequisites() -> bool:
    """V√©rifie les pr√©requis pour la migration"""
    logger.info("üîç V√©rification des pr√©requis...")
    
    issues = []
    
    # V√©rifier fichiers JSON source
    required_files = {
        'projets_data.json': 'Donn√©es projets ERP',
        'crm_data.json': 'Donn√©es CRM',
        'employees_data.json': 'Donn√©es employ√©s',
        'inventaire_v2.json': 'Donn√©es inventaire'
    }
    
    for file, description in required_files.items():
        if not os.path.exists(file):
            issues.append(f"‚ùå {file} manquant ({description})")
        else:
            try:
                with open(file, 'r', encoding='utf-8') as f:
                    data = json.load(f)
                logger.info(f"‚úÖ {file} trouv√© et valide")
            except json.JSONDecodeError as e:
                issues.append(f"‚ùå {file} invalide: {e}")
    
    # V√©rifier module postes_travail
    try:
        from postes_travail import WORK_CENTERS_DG_INC
        if len(WORK_CENTERS_DG_INC) == 61:
            logger.info("‚úÖ Module postes_travail disponible (61 postes)")
        else:
            issues.append(f"‚ùå Postes de travail incorrects: {len(WORK_CENTERS_DG_INC)} au lieu de 61")
    except ImportError:
        issues.append("‚ùå Module postes_travail.py manquant")
    
    # V√©rifier espace disque (CORRECTION SYNTAXE)
    try:
        if hasattr(os, 'statvfs'):
            # Linux/Mac
            stat = os.statvfs('.')
            free_space = stat.f_frsize * stat.f_avail
        else:
            # Windows - utiliser shutil
            import shutil
            free_space = shutil.disk_usage('.').free
        
        if free_space < 100 * 1024 * 1024:  # 100MB minimum
            issues.append("‚ùå Espace disque insuffisant (minimum 100MB)")
        else:
            logger.info(f"‚úÖ Espace disque disponible: {free_space / (1024*1024):.1f} MB")
    except Exception as e:
        logger.warning(f"‚ö†Ô∏è Impossible de v√©rifier l'espace disque: {e}")
    
    if issues:
        logger.error("üö® Pr√©requis non satisfaits:")
        for issue in issues:
            logger.error(f"  {issue}")
        
        # Proposer solutions
        print(f"\nüîß SOLUTIONS PROPOS√âES:")
        if any("manquant" in issue for issue in issues):
            print("   üìÑ Fichiers JSON manquants ‚Üí Ex√©cuter: python test_migration.py")
        if any("postes_travail" in issue for issue in issues):
            print("   üè≠ Module postes_travail ‚Üí V√©rifier pr√©sence du fichier postes_travail.py")
        
        return False
    
    logger.info("‚úÖ Tous les pr√©requis satisfaits")
    return True

def get_migration_plan() -> dict:
    """Retourne le plan de migration d√©taill√©"""
    return {
        'phase_1': {
            'name': 'Pr√©paration',
            'steps': [
                'Cr√©ation base SQLite avec sch√©ma complet',
                'Sauvegarde fichiers JSON existants',
                'Validation structure donn√©es'
            ]
        },
        'phase_2': {
            'name': 'Migration R√©f√©rentiels',
            'steps': [
                'Migration 61 postes de travail',
                'Migration entreprises CRM',
                'Migration contacts CRM'
            ]
        },
        'phase_3': {
            'name': 'Migration Donn√©es M√©tier',
            'steps': [
                'Migration 21 employ√©s DG Inc.',
                'Migration projets avec op√©rations',
                'Migration mat√©riaux et BOM'
            ]
        },
        'phase_4': {
            'name': 'Migration Avanc√©e',
            'steps': [
                'Migration inventaire (mesures imp√©riales)',
                'Int√©gration TimeTracker existant',
                'Cr√©ation relations et index'
            ]
        },
        'phase_5': {
            'name': 'Validation',
            'steps': [
                'Tests int√©grit√© donn√©es',
                'Validation performances',
                'Rapport final'
            ]
        }
    }

def display_migration_plan():
    """Affiche le plan de migration"""
    plan = get_migration_plan()
    
    print("\nüìã PLAN DE MIGRATION:")
    print("=" * 60)
    
    for phase_key, phase in plan.items():
        print(f"\nüîπ {phase['name']} ({phase_key.upper()})")
        for i, step in enumerate(phase['steps'], 1):
            print(f"   {i}. {step}")

def run_interactive_migration():
    """Ex√©cute la migration en mode interactif"""
    print_banner()
    
    # V√©rification pr√©requis
    if not check_prerequisites():
        print("\n‚ùå Migration impossible - Pr√©requis non satisfaits")
        print("\nüîß Pour r√©soudre rapidement:")
        print("   python test_migration.py  # Cr√©e les fichiers JSON manquants")
        return False
    
    # Affichage du plan
    display_migration_plan()
    
    # Confirmation utilisateur
    print(f"\n{'='*60}")
    print("‚ö†Ô∏è  ATTENTION: Cette migration va:")
    print("   ‚Ä¢ Cr√©er une nouvelle base SQLite unifi√©e")
    print("   ‚Ä¢ Sauvegarder automatiquement vos fichiers JSON")
    print("   ‚Ä¢ Transformer l'architecture de votre ERP")
    print(f"{'='*60}")
    
    response = input("\nü§î Voulez-vous continuer? (oui/non): ").lower().strip()
    if response not in ['oui', 'o', 'yes', 'y']:
        print("‚ùå Migration annul√©e par l'utilisateur")
        return False
    
    # Ex√©cution migration
    return execute_migration()

def execute_migration() -> bool:
    """Ex√©cute la migration compl√®te"""
    logger.info("üöÄ D√âBUT MIGRATION COMPL√àTE")
    start_time = datetime.now()
    
    try:
        # Initialisation
        db = ERPDatabase("erp_production_dg.db")
        migration_manager = MigrationManager(db)
        
        print("\n" + "="*60)
        print("üîÑ EX√âCUTION MIGRATION EN COURS...")
        print("="*60)
        
        # Ex√©cution migration
        results = migration_manager.run_full_migration()
        
        # Affichage r√©sultats par module
        print(f"\nüìä R√âSULTATS PAR MODULE:")
        print("-" * 40)
        
        total_migrated = 0
        failed_modules = []
        
        for module_name, module_result in results.get('modules', {}).items():
            if module_result.get('success'):
                count = module_result.get('migrated_count', 0)
                if isinstance(count, dict):
                    # Pour CRM qui a plusieurs compteurs
                    total_count = sum(count.values())
                    detail = ", ".join([f"{k}:{v}" for k, v in count.items()])
                    print(f"‚úÖ {module_name:15} - {total_count:3} enregistrements ({detail})")
                    total_migrated += total_count
                else:
                    print(f"‚úÖ {module_name:15} - {count:3} enregistrements")
                    total_migrated += count
            else:
                error = module_result.get('error', 'Erreur inconnue')
                print(f"‚ùå {module_name:15} - √âCHEC: {error}")
                failed_modules.append(module_name)
        
        # Tests de validation
        print(f"\nüîç VALIDATION POST-MIGRATION:")
        print("-" * 40)
        
        validation_results = validate_migration_results(db)
        
        # Affichage compteurs finaux
        table_counts = validation_results['table_counts']
        for table, count in table_counts.items():
            print(f"üìä {table:20} - {count:4} enregistrements")
        
        # Tests d'int√©grit√©
        integrity_checks = validation_results['integrity_checks']
        integrity_ok = all(integrity_checks.values()) if integrity_checks else True
        
        if integrity_ok:
            print("‚úÖ Int√©grit√© des donn√©es valid√©e")
        else:
            print("‚ö†Ô∏è  Probl√®mes d'int√©grit√© d√©tect√©s:")
            for check, status in integrity_checks.items():
                if not status:
                    print(f"   ‚ùå {check}")
        
        # Test performance
        print(f"\n‚ö° TEST PERFORMANCE:")
        print("-" * 40)
        try:
            perf_results = run_performance_test(db)
            for test_name, time_taken in perf_results.items():
                print(f"üïí {test_name:20} - {time_taken:.4f}s")
        except Exception as e:
            print(f"‚ö†Ô∏è Tests performance √©chou√©s: {e}")
        
        # R√©sum√© final
        end_time = datetime.now()
        duration = end_time - start_time
        
        print(f"\n{'='*60}")
        print("üìã R√âSUM√â FINAL")
        print("="*60)
        print(f"üïí Dur√©e totale:        {duration}")
        print(f"üìä Total migr√©:         {total_migrated} enregistrements")
        
        if 'schema_info' in validation_results:
            print(f"üìÅ Taille base finale:  {validation_results['schema_info']['file_size_mb']} MB")
        
        if failed_modules:
            print(f"‚ö†Ô∏è  Modules √©chou√©s:      {', '.join(failed_modules)}")
            print("üîß Recommandation:      V√©rifier logs pour d√©tails")
        
        if results.get('success') and integrity_ok and not failed_modules:
            print("\nüéâ MIGRATION R√âUSSIE!")
            print("‚úÖ Votre ERP est maintenant unifi√© sur SQLite")
            print("üöÄ Architecture unifi√©e compl√©t√©e avec succ√®s")
            
            # Instructions suite
            print(f"\nüìù PROCHAINES √âTAPES:")
            print("1. ‚úÖ Architecture SQLite cr√©√©e et valid√©e")
            print("2. üöÄ Interface Streamlit pr√™te : streamlit run app.py")
            print("3. üì§ Commit & push vers GitHub pour d√©ploiement")
            print("4. üåê Render.com red√©ploiera automatiquement")
            
            # Commandes rapides
            print(f"\n‚ö° COMMANDES RAPIDES:")
            print("git add erp_production_dg.db *.json")
            print("git commit -m 'feat: Migration SQLite - Architecture unifi√©e'")
            print("git push origin main")
            
            return True
        else:
            print("\n‚ö†Ô∏è  MIGRATION PARTIELLEMENT R√âUSSIE")
            print("üîß V√©rifier les logs pour r√©soudre les probl√®mes")
            print("üìÑ Consultez migration.log pour d√©tails complets")
            return False
    
    except Exception as e:
        logger.error(f"‚ùå Erreur critique migration: {e}")
        print(f"\nüí• ERREUR CRITIQUE: {e}")
        print("üîß Consultez migration.log pour d√©tails")
        
        # Aide au debugging
        import traceback
        logger.error(f"Traceback complet: {traceback.format_exc()}")
        
        return False

def run_automated_migration():
    """Ex√©cute la migration en mode automatique (sans interaction)"""
    print_banner()
    logger.info("ü§ñ Mode automatique - D√©but migration")
    
    if not check_prerequisites():
        logger.error("‚ùå Pr√©requis non satisfaits")
        print("\nüîß Pour cr√©er les fichiers manquants automatiquement:")
        print("   python test_migration.py")
        return False
    
    return execute_migration()

def create_missing_files():
    """Cr√©e automatiquement les fichiers JSON manquants"""
    print("üîß Cr√©ation automatique des fichiers JSON manquants...")
    
    try:
        from test_migration import create_sample_json_files
        create_sample_json_files()
        print("‚úÖ Fichiers JSON cr√©√©s avec succ√®s!")
        return True
    except Exception as e:
        print(f"‚ùå Erreur cr√©ation fichiers: {e}")
        return False

def main():
    """Point d'entr√©e principal"""
    parser = argparse.ArgumentParser(
        description='Migration ERP Production DG Inc. - JSON vers SQLite',
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
Exemples d'utilisation:
  python run_migration.py                    # Mode interactif
  python run_migration.py --auto             # Mode automatique
  python run_migration.py --check-only       # V√©rification uniquement
  python run_migration.py --plan             # Afficher plan seulement
  python run_migration.py --create-files     # Cr√©er fichiers JSON manquants
        """
    )
    
    parser.add_argument('--auto', action='store_true', 
                       help='Mode automatique sans interaction')
    parser.add_argument('--check-only', action='store_true',
                       help='V√©rifier pr√©requis uniquement')
    parser.add_argument('--plan', action='store_true',
                       help='Afficher plan de migration uniquement')
    parser.add_argument('--create-files', action='store_true',
                       help='Cr√©er fichiers JSON manquants automatiquement')
    
    args = parser.parse_args()
    
    if args.plan:
        print_banner()
        display_migration_plan()
        return
    
    if args.create_files:
        print_banner()
        success = create_missing_files()
        sys.exit(0 if success else 1)
    
    if args.check_only:
        print_banner()
        success = check_prerequisites()
        sys.exit(0 if success else 1)
    
    # Ex√©cution migration
    if args.auto:
        success = run_automated_migration()
    else:
        success = run_interactive_migration()
    
    sys.exit(0 if success else 1)

if __name__ == "__main__":
    main()
